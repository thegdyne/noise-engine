#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "$0")/.." && pwd)"

OS="$(uname -s)"
if [[ "$OS" == "Darwin" ]]; then
  CFG_DIR="$HOME/Library/Application Support/NoiseEngine"
elif [[ "$OS" == "Linux" ]]; then
  CFG_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/NoiseEngine"
else
  CFG_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/NoiseEngine"
fi

STATE_DIR="$CFG_DIR/state"
READY="$STATE_DIR/ready.json"
SC_LOG="$STATE_DIR/sclang.log"
SC_PID_FILE="$STATE_DIR/sc.pid"

export NE_CFG_DIR="$CFG_DIR"
export NE_STATE_DIR="$STATE_DIR"

mkdir -p "$STATE_DIR"
rm -f "$READY"

# ---- find sclang ----
if command -v sclang >/dev/null 2>&1; then
  SCLANG="sclang"
elif [[ -x "/Applications/SuperCollider.app/Contents/MacOS/sclang" ]]; then
  SCLANG="/Applications/SuperCollider.app/Contents/MacOS/sclang"
else
  echo "ERROR: sclang not found."
  exit 1
fi

BOOT="$ROOT/supercollider/bootstrap/noise_engine_startup.scd"

echo "Starting SuperCollider..."
"$SCLANG" "$BOOT" >"$SC_LOG" 2>&1 &
SC_PID=$!
echo "SuperCollider pid: $SC_PID"

# Write PID file for scoped cleanup
printf "%s\n" "$SC_PID" > "$SC_PID_FILE"

trap 'kill "$SC_PID" 2>/dev/null || true; rm -f "$SC_PID_FILE"' EXIT

echo "Waiting for ready.json (30s)..."
deadline=$((SECONDS+30))
while (( SECONDS < deadline )); do
  if [[ -f "$READY" ]] && grep -q '"status"[[:space:]]*:[[:space:]]*"ready"' "$READY"; then
    echo "NoiseEngine READY"
    break
  fi
  sleep 0.2
done

if [[ ! -f "$READY" ]] || ! grep -q '"status"[[:space:]]*:[[:space:]]*"ready"' "$READY"; then
  echo "ERROR: NoiseEngine not ready (timeout)."
  tail -n 40 "$SC_LOG" || true
  exit 1
fi

echo "Launching Python..."
cd "$ROOT"
exec "$ROOT/tools/ne-py"
