<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture - Noise Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-panel: #12121a;
            --bg-card: #1a1a25;
            --bg-code: #0d0d14;
            --border: #2a2a3a;
            --border-bright: #3a3a4a;
            --text: #888899;
            --text-bright: #ccccdd;
            --text-dim: #555566;
            --accent-green: #44ff88;
            --accent-orange: #ff8844;
            --accent-magenta: #ff44aa;
            --accent-cyan: #44ddff;
            --accent-yellow: #ffdd44;
            --accent-red: #ff4466;
            --accent-purple: #aa66ff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            padding: 40px 20px;
            line-height: 1.7;
        }
        
        .container { max-width: 1000px; margin: 0 auto; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .back-link {
            color: var(--text);
            text-decoration: none;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
        }
        
        .back-link:hover { color: var(--accent-green); }
        
        h1 {
            font-family: 'Space Mono', monospace;
            font-size: 32px;
            color: var(--text-bright);
        }
        
        h1 span { color: var(--accent-purple); }
        
        /* Table of Contents */
        .toc {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px 30px;
            margin: 30px 0;
        }
        
        .toc h2 {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            color: var(--accent-cyan);
            margin-bottom: 15px;
        }
        
        .toc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px 20px;
        }
        
        .toc a {
            color: var(--text);
            text-decoration: none;
            font-size: 13px;
            padding: 4px 0;
            display: block;
        }
        
        .toc a:hover { color: var(--accent-green); }
        
        .toc a .num {
            color: var(--text-dim);
            font-family: 'Space Mono', monospace;
            margin-right: 8px;
        }
        
        /* Sections */
        .section {
            margin: 50px 0;
        }
        
        .section h2 {
            font-family: 'Space Mono', monospace;
            font-size: 22px;
            color: var(--text-bright);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--section-color, var(--accent-green));
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section h2 .num {
            background: var(--section-color, var(--accent-green));
            color: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .section h3 {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            color: var(--accent-cyan);
            margin: 25px 0 15px 0;
        }
        
        .section p {
            color: var(--text-bright);
            margin: 15px 0;
        }
        
        .section ul, .section ol {
            margin: 15px 0 15px 25px;
            color: var(--text-bright);
        }
        
        .section li {
            margin: 8px 0;
        }
        
        /* Code blocks */
        pre {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        pre code {
            color: var(--text-bright);
        }
        
        .code-inline {
            font-family: 'Space Mono', monospace;
            background: var(--bg-code);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-cyan);
            font-size: 13px;
        }
        
        /* Callouts */
        .callout {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--callout-color, var(--accent-cyan));
            border-radius: 4px;
            padding: 15px 20px;
            margin: 20px 0;
        }
        
        .callout.warning {
            --callout-color: var(--accent-orange);
        }
        
        .callout.danger {
            --callout-color: var(--accent-red);
        }
        
        .callout.success {
            --callout-color: var(--accent-green);
        }
        
        .callout-title {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--callout-color, var(--accent-cyan));
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .callout p {
            margin: 0;
            color: var(--text-bright);
            font-size: 14px;
        }
        
        /* Diagrams */
        .diagram {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
        }
        
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .flow-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px 18px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-bright);
            text-align: center;
        }
        
        .flow-box.highlight {
            border-color: var(--accent-green);
            background: rgba(68, 255, 136, 0.1);
        }
        
        .flow-arrow {
            color: var(--text-dim);
            font-size: 20px;
        }
        
        /* File tree */
        .file-tree {
            background: var(--bg-code);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
        }
        
        .file-tree .folder {
            color: var(--accent-yellow);
        }
        
        .file-tree .file {
            color: var(--text-bright);
        }
        
        .file-tree .comment {
            color: var(--text-dim);
        }
        
        .file-tree div {
            margin: 4px 0;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-card);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--accent-cyan);
            text-transform: uppercase;
        }
        
        td {
            font-size: 14px;
            color: var(--text-bright);
        }
        
        td code {
            font-family: 'Space Mono', monospace;
            color: var(--accent-green);
            font-size: 12px;
        }
        
        /* Syntax highlighting (minimal) */
        .kw { color: var(--accent-magenta); }
        .fn { color: var(--accent-cyan); }
        .str { color: var(--accent-green); }
        .num { color: var(--accent-orange); }
        .cmt { color: var(--text-dim); }
        .var { color: var(--accent-yellow); }
        
        /* Contract box */
        .contract-box {
            background: var(--bg-panel);
            border: 2px solid var(--accent-purple);
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .contract-box h4 {
            font-family: 'Space Mono', monospace;
            color: var(--accent-purple);
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .toc-grid { grid-template-columns: 1fr; }
            .flow-diagram { flex-direction: column; }
            .flow-arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="demo-index.html" class="back-link">← Back to Demo</a>
            <h1><span>§</span> Architecture</h1>
        </header>
        
        <!-- Table of Contents -->
        <div class="toc">
            <h2>Contents</h2>
            <div class="toc-grid">
                <a href="#layout"><span class="num">1</span> Repository Layout</a>
                <a href="#core"><span class="num">2</span> What a Generator Is</a>
                <a href="#contract"><span class="num">3</span> SynthDef Contract</a>
                <a href="#triggers"><span class="num">4</span> Trigger Buses (Gotcha!)</a>
                <a href="#buses"><span class="num">5</span> Bus Model</a>
                <a href="#custom-env"><span class="num">6</span> Custom Envelopes</a>
                <a href="#amplitude"><span class="num">7</span> Amplitude Bus</a>
                <a href="#json"><span class="num">8</span> JSON Metadata</a>
                <a href="#pitch"><span class="num">9</span> pitch_target</a>
                <a href="#retrig"><span class="num">10</span> midi_retrig</a>
                <a href="#trim"><span class="num">11</span> output_trim_db</a>
                <a href="#safety"><span class="num">12</span> Safety (LeakDC/Limiter)</a>
                <a href="#workflow"><span class="num">13</span> Adding a Generator</a>
                <a href="#skeleton"><span class="num">A</span> SynthDef Skeleton</a>
            </div>
        </div>
        
        <!-- Section 1: Layout -->
        <div class="section" id="layout" style="--section-color: var(--accent-cyan)">
            <h2><span class="num">1</span> Repository Layout</h2>
            
            <div class="file-tree">
                <div><span class="folder">supercollider/</span></div>
                <div>&nbsp;&nbsp;<span class="folder">generators/</span></div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="file">*.scd</span> <span class="comment">← Individual SynthDefs</span></div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="file">*.json</span> <span class="comment">← UI metadata (labels, ranges, curves)</span></div>
                <div>&nbsp;&nbsp;<span class="folder">core/</span></div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="file">helpers.scd</span> <span class="comment">← ~ensure2ch, ~multiFilter, ~envVCA, ~stereoSpread</span></div>
                <div></div>
                <div><span class="folder">src/</span></div>
                <div>&nbsp;&nbsp;<span class="folder">config/</span></div>
                <div>&nbsp;&nbsp;&nbsp;&nbsp;<span class="file">__init__.py</span> <span class="comment">← GENERATOR_CYCLE, loads JSON configs</span></div>
            </div>
            
            <h3>Helper Functions</h3>
            <table>
                <tr>
                    <th>Function</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td><code>~ensure2ch.(sig)</code></td>
                    <td>Force signal to exactly 2 channels (stereo)</td>
                </tr>
                <tr>
                    <td><code>~multiFilter.(sig, type, freq, rq)</code></td>
                    <td>Shared LP/HP/BP filter (type: 0/1/2)</td>
                </tr>
                <tr>
                    <td><code>~envVCA.(sig, ...)</code></td>
                    <td>Envelope VCA with OFF/CLK/MIDI triggering</td>
                </tr>
                <tr>
                    <td><code>~stereoSpread.(sig, rate, width)</code></td>
                    <td>LFO-modulated pan for stereo width</td>
                </tr>
            </table>
        </div>
        
        <!-- Section 2: Core Design -->
        <div class="section" id="core" style="--section-color: var(--accent-green)">
            <h2><span class="num">2</span> What a Generator Is</h2>
            
            <p>A generator is a <strong>single SynthDef</strong> that produces audio and connects to the shared post-chain.</p>
            
            <div class="diagram">
                <div class="flow-diagram">
                    <div class="flow-box">Control Buses<br><small>(mapped Hz, sec, 0-1)</small></div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-box highlight">Your DSP<br><small>(sig = ...)</small></div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-box">~ensure2ch</div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-box">~multiFilter</div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-box">~envVCA</div>
                    <span class="flow-arrow">→</span>
                    <div class="flow-box">Out.ar</div>
                </div>
            </div>
            
            <p>The UI always provides:</p>
            <ul>
                <li><strong>Standard sliders:</strong> FRQ, CUT, RES, ATK, DEC</li>
                <li><strong>Custom sliders:</strong> P1–P5 (up to 5, defined in JSON)</li>
            </ul>
        </div>
        
        <!-- Section 3: Contract -->
        <div class="section" id="contract" style="--section-color: var(--accent-purple)">
            <h2><span class="num">3</span> The Hard SynthDef Contract</h2>
            
            <div class="contract-box">
                <h4>⚠ Non-Negotiable</h4>
                <p>Every generator <strong>must</strong> accept this exact argument signature because <code>~startGenerator</code> sets these keys.</p>
            </div>
            
            <h3>3.1 Mandatory Args</h3>
            <pre><code><span class="fn">SynthDef</span>(<span class="str">\yourSynthDefName</span>, { |<span class="var">out</span>,
    <span class="var">freqBus</span>, <span class="var">cutoffBus</span>, <span class="var">resBus</span>, <span class="var">attackBus</span>, <span class="var">decayBus</span>,
    <span class="var">filterTypeBus</span>, <span class="var">envEnabledBus</span>, <span class="var">envSourceBus</span>=<span class="num">0</span>, <span class="var">clockRateBus</span>, <span class="var">clockTrigBus</span>,
    <span class="var">midiTrigBus</span>=<span class="num">0</span>, <span class="var">slotIndex</span>=<span class="num">0</span>,
    <span class="var">customBus0</span>, <span class="var">customBus1</span>, <span class="var">customBus2</span>, <span class="var">customBus3</span>, <span class="var">customBus4</span>|
    ...
}).<span class="fn">add</span>;</code></pre>
            
            <h3>3.2 Mandatory Bus Reads</h3>
            <pre><code><span class="kw">var</span> <span class="var">freq</span>       = <span class="fn">In.kr</span>(<span class="var">freqBus</span>);
<span class="kw">var</span> <span class="var">filterFreq</span> = <span class="fn">In.kr</span>(<span class="var">cutoffBus</span>);
<span class="kw">var</span> <span class="var">rq</span>         = <span class="fn">In.kr</span>(<span class="var">resBus</span>);
<span class="kw">var</span> <span class="var">attack</span>     = <span class="fn">In.kr</span>(<span class="var">attackBus</span>);
<span class="kw">var</span> <span class="var">decay</span>      = <span class="fn">In.kr</span>(<span class="var">decayBus</span>);
<span class="kw">var</span> <span class="var">filterType</span> = <span class="fn">In.kr</span>(<span class="var">filterTypeBus</span>);
<span class="kw">var</span> <span class="var">envSource</span>  = <span class="fn">In.kr</span>(<span class="var">envSourceBus</span>);
<span class="kw">var</span> <span class="var">clockRate</span>  = <span class="fn">In.kr</span>(<span class="var">clockRateBus</span>);
<span class="kw">var</span> <span class="var">amp</span>        = <span class="fn">In.kr</span>(~params[<span class="str">\amplitude</span>]);

<span class="kw">var</span> <span class="var">p1</span> = <span class="fn">In.kr</span>(<span class="var">customBus0</span>);
<span class="kw">var</span> <span class="var">p2</span> = <span class="fn">In.kr</span>(<span class="var">customBus1</span>);
<span class="kw">var</span> <span class="var">p3</span> = <span class="fn">In.kr</span>(<span class="var">customBus2</span>);
<span class="kw">var</span> <span class="var">p4</span> = <span class="fn">In.kr</span>(<span class="var">customBus3</span>);
<span class="kw">var</span> <span class="var">p5</span> = <span class="fn">In.kr</span>(<span class="var">customBus4</span>);</code></pre>
            
            <h3>3.3 Mandatory Post-Chain Order</h3>
            <pre><code><span class="cmt">// After your DSP assigns sig:</span>
<span class="var">sig</span> = ~<span class="fn">ensure2ch</span>.(<span class="var">sig</span>);      <span class="cmt">// FIRST: enforce 2ch</span>
<span class="var">sig</span> = ~<span class="fn">multiFilter</span>.(<span class="var">sig</span>, <span class="var">filterType</span>, <span class="var">filterFreq</span>, <span class="var">rq</span>);
<span class="var">sig</span> = ~<span class="fn">envVCA</span>.(<span class="var">sig</span>, <span class="var">envSource</span>, <span class="var">clockRate</span>, <span class="var">attack</span>, <span class="var">decay</span>, <span class="var">amp</span>, <span class="var">clockTrigBus</span>, <span class="var">midiTrigBus</span>, <span class="var">slotIndex</span>);
<span class="fn">Out.ar</span>(<span class="var">out</span>, <span class="var">sig</span>);</code></pre>
            
            <div class="callout">
                <div class="callout-title">Stereo Spread Placement</div>
                <p><code>~stereoSpread.(sig, rate, width)</code> uses Pan2.ar — call it <strong>before</strong> ~ensure2ch on mono signals only.</p>
            </div>
        </div>
        
        <!-- Section 4: Triggers -->
        <div class="section" id="triggers" style="--section-color: var(--accent-red)">
            <h2><span class="num">4</span> Critical Gotcha: Trigger Buses Are AUDIO Rate</h2>
            
            <div class="callout danger">
                <div class="callout-title">⚠ This Will Bite You</div>
                <p>The clock and MIDI trigger buses are <strong>audio-rate multi-channel</strong> buses, not control-rate single-channel.</p>
            </div>
            
            <table>
                <tr>
                    <th>Bus</th>
                    <th>Rate</th>
                    <th>Channels</th>
                    <th>Purpose</th>
                </tr>
                <tr>
                    <td><code>clockTrigBus</code></td>
                    <td>Audio</td>
                    <td>13</td>
                    <td>One trigger stream per clock rate</td>
                </tr>
                <tr>
                    <td><code>midiTrigBus</code></td>
                    <td>Audio</td>
                    <td>8</td>
                    <td>One trigger stream per slot</td>
                </tr>
            </table>
            
            <h3>❌ Wrong</h3>
            <pre><code><span class="cmt">// DON'T DO THIS - triggers are NOT control-rate!</span>
<span class="var">envTrig</span> = <span class="fn">In.kr</span>(<span class="var">clockTrigBus</span> + <span class="var">clockRate</span>);</code></pre>
            
            <h3>✓ Correct</h3>
            <pre><code><span class="cmt">// Select from 13-channel audio trigger bus</span>
<span class="kw">var</span> <span class="var">allClockTrigs</span> = <span class="fn">In.ar</span>(<span class="var">clockTrigBus</span>, <span class="num">13</span>);
<span class="kw">var</span> <span class="var">clockTrig</span>     = <span class="fn">Select.ar</span>(<span class="var">clockRate</span>.<span class="fn">round</span>, <span class="var">allClockTrigs</span>);

<span class="cmt">// Select from 8-channel MIDI trigger bus</span>
<span class="kw">var</span> <span class="var">allMidiTrigs</span> = <span class="fn">In.ar</span>(<span class="var">midiTrigBus</span>, <span class="num">8</span>);
<span class="kw">var</span> <span class="var">midiTrig</span>     = <span class="fn">Select.ar</span>(<span class="var">slotIndex</span>, <span class="var">allMidiTrigs</span>);</code></pre>
            
            <div class="callout success">
                <div class="callout-title">Good News</div>
                <p><code>~envVCA</code> already handles this correctly. Only worry about it if you need custom envelopes (see Section 6).</p>
            </div>
        </div>
        
        <!-- Section 5: Buses -->
        <div class="section" id="buses" style="--section-color: var(--accent-yellow)">
            <h2><span class="num">5</span> Bus Model: Mapped Values</h2>
            
            <p>Control buses carry <strong>mapped real-world values</strong>, not normalized 0–1:</p>
            
            <table>
                <tr>
                    <th>Bus</th>
                    <th>Unit</th>
                    <th>Example Value</th>
                </tr>
                <tr>
                    <td><code>freq</code></td>
                    <td>Hz</td>
                    <td>440.0</td>
                </tr>
                <tr>
                    <td><code>cutoff</code></td>
                    <td>Hz</td>
                    <td>2000.0</td>
                </tr>
                <tr>
                    <td><code>attack/decay</code></td>
                    <td>seconds</td>
                    <td>0.5</td>
                </tr>
                <tr>
                    <td><code>rq</code></td>
                    <td>0–1 (RQ)</td>
                    <td>0.3</td>
                </tr>
                <tr>
                    <td><code>P1–P5</code></td>
                    <td>per JSON</td>
                    <td>(varies)</td>
                </tr>
            </table>
            
            <div class="callout warning">
                <div class="callout-title">Rule: No Double-Mapping</div>
                <p>Python does lin/exp/steps mapping via <code>map_value()</code>. SC should use bus values <strong>as-is</strong>.</p>
            </div>
        </div>
        
        <!-- Section 6: Custom Envelopes -->
        <div class="section" id="custom-env" style="--section-color: var(--accent-orange)">
            <h2><span class="num">6</span> Generators With Custom Envelopes</h2>
            
            <p>Some generators need internal envelopes for:</p>
            <ul>
                <li>Filter cutoff modulation (acid / 808-style)</li>
                <li>Exciter shaping (karplus / modal)</li>
                <li>LPG behavior (Buchla)</li>
            </ul>
            
            <h3>Rules</h3>
            <ol>
                <li>Triggers <strong>must be audio-rate</strong> (In.ar, Select.ar)</li>
                <li>Use <code>EnvGen.ar</code> (not .kr)</li>
                <li>Either keep <code>~envVCA</code> for amplitude, or handle amp yourself</li>
            </ol>
            
            <h3>Example: Filter Envelope</h3>
            <pre><code><span class="cmt">// Choose trigger: 0=OFF, 1=CLK, 2=MIDI</span>
<span class="kw">var</span> <span class="var">trig</span> = <span class="fn">Select.ar</span>(<span class="var">envSource</span>, [
    <span class="fn">DC.ar</span>(<span class="num">0</span>),
    <span class="fn">Select.ar</span>(<span class="var">clockRate</span>.<span class="fn">round</span>, <span class="fn">In.ar</span>(<span class="var">clockTrigBus</span>, <span class="num">13</span>)),
    <span class="fn">Select.ar</span>(<span class="var">slotIndex</span>, <span class="fn">In.ar</span>(<span class="var">midiTrigBus</span>, <span class="num">8</span>))
]);

<span class="cmt">// Use custom param for filter decay (independent from amp decay)</span>
<span class="kw">var</span> <span class="var">filtDecay</span> = <span class="fn">In.kr</span>(<span class="var">customBus3</span>);  <span class="cmt">// P4</span>
<span class="kw">var</span> <span class="var">filtEnv</span> = <span class="fn">EnvGen.ar</span>(<span class="fn">Env.perc</span>(<span class="num">0.001</span>, <span class="var">filtDecay</span>), <span class="var">trig</span>);

<span class="cmt">// Modulate filter cutoff</span>
<span class="var">filtFreqMod</span> = <span class="var">filterFreq</span> * (<span class="num">1</span> + (<span class="var">filtEnv</span> * <span class="var">envDepth</span> * <span class="num">4</span>));

<span class="cmt">// Still use shared amplitude VCA</span>
<span class="var">sig</span> = ~<span class="fn">envVCA</span>.(<span class="var">sig</span>, ...);</code></pre>
        </div>
        
        <!-- Section 7: Amplitude -->
        <div class="section" id="amplitude" style="--section-color: var(--accent-cyan)">
            <h2><span class="num">7</span> ~params[\amplitude]</h2>
            
            <p><code>~params[\amplitude]</code> is the global per-slot amplitude scalar (control-rate bus).</p>
            
            <ul>
                <li>If using <code>~envVCA</code>: pass <code>amp</code> to it ✓</li>
                <li>If bypassing <code>~envVCA</code>: you <strong>must</strong> multiply by <code>amp</code> yourself</li>
            </ul>
            
            <pre><code><span class="cmt">// If handling amplitude yourself:</span>
<span class="var">sig</span> = <span class="var">sig</span> * <span class="var">amp</span>;</code></pre>
        </div>
        
        <!-- Section 8: JSON -->
        <div class="section" id="json" style="--section-color: var(--accent-green)">
            <h2><span class="num">8</span> Generator Metadata (.json)</h2>
            
            <h3>Minimal Schema</h3>
            <pre><code>{
  <span class="str">"name"</span>: <span class="str">"Human Name"</span>,
  <span class="str">"synthdef"</span>: <span class="str">"scSynthDefSymbol"</span>,
  <span class="str">"output_trim_db"</span>: <span class="num">-6.0</span>,
  <span class="str">"midi_retrig"</span>: <span class="num">false</span>,
  <span class="str">"pitch_target"</span>: <span class="num">null</span>,
  <span class="str">"custom_params"</span>: []
}</code></pre>
            
            <h3>Custom Param Entry</h3>
            <pre><code>{
  <span class="str">"key"</span>: <span class="str">"delay_time"</span>,
  <span class="str">"label"</span>: <span class="str">"DLY"</span>,       <span class="cmt">// 3-4 chars</span>
  <span class="str">"tooltip"</span>: <span class="str">"Delay Time"</span>,
  <span class="str">"default"</span>: <span class="num">0.30</span>,
  <span class="str">"min"</span>: <span class="num">0.005</span>,
  <span class="str">"max"</span>: <span class="num">1.0</span>,
  <span class="str">"curve"</span>: <span class="str">"exp"</span>,       <span class="cmt">// "lin" or "exp"</span>
  <span class="str">"unit"</span>: <span class="str">"s"</span>,
  <span class="str">"steps"</span>: <span class="num">null</span>         <span class="cmt">// integer for discrete steps</span>
}</code></pre>
            
            <div class="callout">
                <div class="callout-title">Rules</div>
                <p><code>exp</code> requires <code>min > 0</code> • <code>default</code> must be within [min, max] • Max 5 custom params</p>
            </div>
        </div>
        
        <!-- Section 9-11: Short sections -->
        <div class="section" id="pitch" style="--section-color: var(--accent-magenta)">
            <h2><span class="num">9</span> pitch_target</h2>
            <ul>
                <li><code>null</code> — pitch controls <code>frequency</code> bus (default)</li>
                <li><code>0..4</code> — pitch targets custom param P1..P5</li>
            </ul>
            <p>Use this for generators where "pitch" means something else (e.g. delay-time-as-pitch).</p>
        </div>
        
        <div class="section" id="retrig" style="--section-color: var(--accent-orange)">
            <h2><span class="num">10</span> midi_retrig</h2>
            <p>For struck/plucked models (Karplus, Modal) that need <strong>continuous retriggering</strong> while a MIDI key is held (~30 Hz), not just a single impulse.</p>
        </div>
        
        <div class="section" id="trim" style="--section-color: var(--accent-yellow)">
            <h2><span class="num">11</span> output_trim_db</h2>
            <p>Per-generator loudness trim applied at the channel strip level. Use this to match loudness across generator types — don't bake trims into .scd files.</p>
        </div>
        
        <!-- Section 12: Safety -->
        <div class="section" id="safety" style="--section-color: var(--accent-red)">
            <h2><span class="num">12</span> Safety: LeakDC / Limiter</h2>
            
            <p><strong>Required</strong> for generators with:</p>
            <ul>
                <li>Feedback (LocalIn/LocalOut, delay chaos)</li>
                <li>Hard nonlinearities (fold/clip) + high gain</li>
                <li>Unstable/self-oscillating filters</li>
            </ul>
            
            <pre><code><span class="cmt">// Place BEFORE post-chain</span>
<span class="var">sig</span> = <span class="fn">LeakDC.ar</span>(<span class="var">sig</span>);
<span class="var">sig</span> = <span class="fn">Limiter.ar</span>(<span class="var">sig</span>, <span class="num">0.98</span>);</code></pre>
            
            <div class="callout danger">
                <div class="callout-title">Why This Matters</div>
                <p>Prevents NaNs/Infs and "silent after blowup" states that are painful to debug.</p>
            </div>
        </div>
        
        <!-- Section 13: Workflow -->
        <div class="section" id="workflow" style="--section-color: var(--accent-green)">
            <h2><span class="num">13</span> Adding a New Generator (10–20 min)</h2>
            
            <ol>
                <li>Copy a close-ish <code>.scd</code> → <code>supercollider/generators/&lt;new&gt;.scd</code></li>
                <li>Copy its <code>.json</code> → <code>supercollider/generators/&lt;new&gt;.json</code></li>
                <li>Edit JSON: <code>name</code>, <code>synthdef</code>, <code>output_trim_db</code>, <code>custom_params</code></li>
                <li>Edit SC: rename SynthDef symbol, implement DSP, keep post-chain</li>
                <li>Add generator name to <code>GENERATOR_CYCLE</code> in <code>src/config/__init__.py</code></li>
            </ol>
            
            <div class="callout success">
                <div class="callout-title">Smoke Test Checklist</div>
                <p>✓ Loads with no SC errors • ✓ Produces stereo • ✓ Filter + env work • ✓ P1–P5 do something • ✓ Reasonable loudness</p>
            </div>
        </div>
        
        <!-- Appendix A: Skeleton -->
        <div class="section" id="skeleton" style="--section-color: var(--accent-purple)">
            <h2><span class="num">A</span> Canonical SynthDef Skeleton</h2>
            
            <pre><code><span class="fn">SynthDef</span>(<span class="str">\TEMPLATE</span>, { |<span class="var">out</span>,
    <span class="var">freqBus</span>, <span class="var">cutoffBus</span>, <span class="var">resBus</span>, <span class="var">attackBus</span>, <span class="var">decayBus</span>,
    <span class="var">filterTypeBus</span>, <span class="var">envEnabledBus</span>, <span class="var">envSourceBus</span>=<span class="num">0</span>, <span class="var">clockRateBus</span>, <span class="var">clockTrigBus</span>,
    <span class="var">midiTrigBus</span>=<span class="num">0</span>, <span class="var">slotIndex</span>=<span class="num">0</span>,
    <span class="var">customBus0</span>, <span class="var">customBus1</span>, <span class="var">customBus2</span>, <span class="var">customBus3</span>, <span class="var">customBus4</span>|

    <span class="kw">var</span> <span class="var">freq</span>       = <span class="fn">In.kr</span>(<span class="var">freqBus</span>);
    <span class="kw">var</span> <span class="var">filterFreq</span> = <span class="fn">In.kr</span>(<span class="var">cutoffBus</span>);
    <span class="kw">var</span> <span class="var">rq</span>         = <span class="fn">In.kr</span>(<span class="var">resBus</span>);
    <span class="kw">var</span> <span class="var">attack</span>     = <span class="fn">In.kr</span>(<span class="var">attackBus</span>);
    <span class="kw">var</span> <span class="var">decay</span>      = <span class="fn">In.kr</span>(<span class="var">decayBus</span>);
    <span class="kw">var</span> <span class="var">filterType</span> = <span class="fn">In.kr</span>(<span class="var">filterTypeBus</span>);
    <span class="kw">var</span> <span class="var">envSource</span>  = <span class="fn">In.kr</span>(<span class="var">envSourceBus</span>);
    <span class="kw">var</span> <span class="var">clockRate</span>  = <span class="fn">In.kr</span>(<span class="var">clockRateBus</span>);
    <span class="kw">var</span> <span class="var">amp</span>        = <span class="fn">In.kr</span>(~params[<span class="str">\amplitude</span>]);

    <span class="kw">var</span> <span class="var">p1</span> = <span class="fn">In.kr</span>(<span class="var">customBus0</span>);
    <span class="kw">var</span> <span class="var">p2</span> = <span class="fn">In.kr</span>(<span class="var">customBus1</span>);
    <span class="kw">var</span> <span class="var">p3</span> = <span class="fn">In.kr</span>(<span class="var">customBus2</span>);
    <span class="kw">var</span> <span class="var">p4</span> = <span class="fn">In.kr</span>(<span class="var">customBus3</span>);
    <span class="kw">var</span> <span class="var">p5</span> = <span class="fn">In.kr</span>(<span class="var">customBus4</span>);

    <span class="kw">var</span> <span class="var">sig</span>;

    <span class="cmt">// ---- DSP ----</span>
    <span class="cmt">// sig = ...</span>

    <span class="cmt">// ---- Safety (REQUIRED for feedback/chaos) ----</span>
    <span class="cmt">// sig = LeakDC.ar(sig);</span>
    <span class="cmt">// sig = Limiter.ar(sig, 0.98);</span>

    <span class="cmt">// ---- Optional width (mono-only) ----</span>
    <span class="cmt">// sig = ~stereoSpread.(sig, 0.3, 0.2);</span>

    <span class="cmt">// ---- Post-chain (SSOT) ----</span>
    <span class="var">sig</span> = ~<span class="fn">ensure2ch</span>.(<span class="var">sig</span>);
    <span class="var">sig</span> = ~<span class="fn">multiFilter</span>.(<span class="var">sig</span>, <span class="var">filterType</span>, <span class="var">filterFreq</span>, <span class="var">rq</span>);
    <span class="var">sig</span> = ~<span class="fn">envVCA</span>.(<span class="var">sig</span>, <span class="var">envSource</span>, <span class="var">clockRate</span>, <span class="var">attack</span>, <span class="var">decay</span>, <span class="var">amp</span>, <span class="var">clockTrigBus</span>, <span class="var">midiTrigBus</span>, <span class="var">slotIndex</span>);

    <span class="fn">Out.ar</span>(<span class="var">out</span>, <span class="var">sig</span>);
}).<span class="fn">add</span>;

<span class="str">"  ✓ TEMPLATE loaded"</span>.<span class="fn">postln</span>;</code></pre>
        </div>
    </div>
</body>
</html>
